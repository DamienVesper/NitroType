# More sophisticated port of `race.user.js`
# PATCHED JULY 2020

import requests
from datetime import datetime
import json
from pynput import keyboard
from pynput.keyboard import Key, Controller
import random
import browser_cookie3
print("Backspace Racing Program v1.4.1 - Copyright c Limitized (http://www.github.com/limitized). All rights reserved.")
print('SETUP:')
print('1. Login to your NitroType account through Google Chrome. (Press [ENTER] when completed)')
a = input()
print('2. Re-arrange your garage. (Move some cars around and then save it) **VERY IMPORTANT STEP (Press [ENTER] when completed)')
a = input()
print('3. Choose what car that you would like to use for the session (Type the car ID and press [ENTER] when completed).')
print("----------------------------------------------------------------------------------------------------")
carID = str(input())
if(carID == ''):
    carID = '17'

print("Using car ID: " + carID)
print('Retreiving cookies...')

print("----------------------------------------------------------------------------------------------------")
print('Type the [BACKSPACE] key and then start racing! Then, type the [BACKSPACE] key whenever you finish a race!')
print("Detecting key presses...")
print("----------CONSOLE----------")
def get_uhash():
    cj = browser_cookie3.chrome(domain_name = "nitrotype.com")
    return(cj)

cj = get_uhash()

COMBINATIONS = [{keyboard.Key.backspace}]
current = set()
keyboard1 = Controller()
lastTimeStamp = [1]
userCar = []

def execute():
    for cookie in cj:
        if(str(cookie.name) == 'ntuserrem'):
            uhash = cookie.value
    #carIDList = [3, 15, 17]
    #randomCarPoint = random.randrange(0,len(carIDList), 1)
    #randomCar = str(carIDList[randomCarPoint])
    lastTimePressed = lastTimeStamp[len(lastTimeStamp) - 1]
    timeNow = datetime.now()
    timestampNow = float(datetime.timestamp(timeNow))
    difference = timestampNow - lastTimePressed
    if(difference >= 8):
        get1 = requests.post("https://www.nitrotype.com/api/race/save-qualifying", headers = {"Content-Type": "application/x-www-form-urlencoded"}, data = f"speed=5&carID=17&uhash={uhash}", cookies = cj)
        print(get1.text)
        lastTimeStamp.append(timestampNow)
        get2 = requests.post(url = f"https://www.nitrotype.com/api/cars/{carID}/use", headers = {"Content-Type": "application/x-www-form-urlencoded"}, data = f'uhash={uhash}', cookies = cj)
        keyboard1.press(Key.enter)
        return None
    else:
        print("You are on cooldown! Please try again soon!")
        return None


def on_press(key):
    if any([key in COMBO for COMBO in COMBINATIONS]):
        current.add(key)
        if any(all(k in current for k in COMBO) for COMBO in COMBINATIONS):
            execute()
            


def on_release(key):
    if any([key in COMBO for COMBO in COMBINATIONS]):
        current.remove(key)




with keyboard.Listener(on_press=on_press, on_release=on_release) as listener:
            listener.join()
