# Python port of `cash.user.js`
# PATCHED JULY 2020

import asyncio
import aiohttp
import json
import time
injectURL = "https://www.nitrotype.com/api/race/save-qualifying"
headers = {"Content-Type": "application/x-www-form-urlencoded"}
car1 = "17"
car2 = "15"
car3 = "3"

#json_thing = open("config.json")
#file = json.load(json_thing)


#username = str(file["username"])
#password = str(file["password"])


username = "my_username"
password = "my_password"

async def fetch(session, url, rawdata):
    async with session.post(url, headers = headers, data = rawdata) as response:
        return await response.text()

async def buySell(client, uhash):
    injectCar1 = await fetch(client, injectURL, f"speed=30&carID={car1}&uhash={uhash}")
    print(injectCar1)
    sellCar2 = await fetch(client, f"https://www.nitrotype.com/api/cars/{car2}/sell", f"carID={car2}&password={password}&uhash={uhash}")
    injectCar3 = await fetch(client, injectURL, f"speed=70&carID={car3}&uhash={uhash}")
    sellCar1 = await fetch(client, f"https://www.nitrotype.com/api/cars/{car1}/sell", f"carID={car1}&password={password}&uhash={uhash}")
    injectCar2 = await fetch(client, injectURL, f"speed=90&carID={car2}&uhash={uhash}")
    sellCar3 = await fetch(client, f"https://www.nitrotype.com/api/cars/{car3}/sell",f"carID={car3}&password={password}&uhash={uhash}")
async def looper(client, uhash):
    while True:
        try:
            #results = await asyncio.gather(*(buySell(client, uhash) for x in range(14)))
            results = await asyncio.gather(*(buySell(client, uhash) for x in range(3)))
        except asyncio.CancelledError:
            pass
async def main(username, password):
    async with aiohttp.ClientSession(cookie_jar=aiohttp.CookieJar(), connector=aiohttp.TCPConnector(verify_ssl=False)) as client:
        loginRequest = await fetch(client, "https://www.nitrotype.com/api/login", "username=" + username + "&password=" + password)
        
        print(loginRequest)
        time.sleep(5)
        print("Generating Cash...")
        
        cookies = client.cookie_jar.filter_cookies('http://www.nitrotype.com')
        for key, cookie in cookies.items():
            if key == 'ntuserrem':
                uhash = cookie.value
        while True:
            await asyncio.wait_for(looper(client, uhash), timeout=60.0*60)
            await asyncio.sleep(60.0*10)

             
asyncio.run(main(username, password))
